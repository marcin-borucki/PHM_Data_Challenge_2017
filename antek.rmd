---
title: "Antek"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
#library(dplyr)

```

## Intro

This is an analysis file - its intention is to be used as a high level pre- and post-processing, data visualization etc...


##Read in data

```{r read in data and functions}

data_train <- readRDS("./input/train_data.RDS")

data_test  <- readRDS("./input/test_data.RDS")

#linear models:
source("./R Scripts/linear_models.R")

```

## Linear models  
  
this part is focused on separate linear models for all spring- dumper pairs.

```{r linear models}

# original models
source("./R Scripts/models_eq1.R")

res1<-run_fits(model_df = models, data_df = data_train)

res1$Track<-ifelse(res1$ExperimentID<101,1,2)
# boggie models without platform
source("./R Scripts/models_eq2.R")

res2<-run_fits(model_df = models, data_df = data_train)

res2$Track<-ifelse(res2$ExperimentID<101,1,2)

# boggie models just with wheels
source("./R Scripts/models_eq3.R")

res3<-run_fits(model_df = models, data_df = data_train)

res3$Track<-ifelse(res3$ExperimentID<101,1,2)

```

## First attempt models - with all neighbouring acc-meters

```{r linear analysis post proc, echo = FALSE, fig.height=10, fig.width=14, fig.cap="---  \n" }

for(modeli in min(res1$model):max(res1$model)){
 model_id=modeli

 p <- ggplot(res1[res1$model == model_id,],aes(x = freq, y= c2)) + 
  geom_violin(aes(fill = as.factor(freq))) +
  geom_violin(data = res1[res1$model == model_id,],aes(
         x = freq + 0.25,
         y = c2/Speed,
         color = ExperimentID,
         fill = as.factor(freq)
  )) +
  geom_violin(data = res1[res1$model == model_id, ], aes(
       x = freq + 0.5,
         y = c2/((Speed)*(Payload)),
         color = ExperimentID,
         fill = as.factor(freq)
       ))  +
     geom_violin(data = res1[res1$model == model_id, ], aes(
         x = freq + 0.75,
         y = c2/((Speed^2)*(Payload^2)),
         color = ExperimentID,
         fill = as.factor(freq)
     ))+
  facet_grid(as.factor(Track) ~ as.factor(Speed)) +
  labs(title=paste("Normalization by Speed, Speed x Payload and Speed^2 x Payload^2 \n model:",modeli,sep=""))
 
 show(p)

 p <- ggplot(res1[res1$model == model_id,],aes(x = freq, y= c2)) + 
  geom_violin(aes(fill = as.factor(freq))) +
  geom_violin(data = res1[res1$model == model_id,],aes(
         x = freq + 0.25,
         y = c2/Payload,
         color = ExperimentID,
         fill = as.factor(freq)
  )) +
  geom_violin(data = res1[res1$model == model_id, ], aes(
       x = freq + 0.5,
         y = c2/(Payload^0.5),
         color = ExperimentID,
         fill = as.factor(freq)
       ))  +
     geom_violin(data = res1[res1$model == model_id, ], aes(
         x = freq + 0.75,
         y = c2/(Payload^2),
         color = ExperimentID,
         fill = as.factor(freq)
     ))+
  facet_grid(as.factor(Track) ~ as.factor(Speed)) +
  labs(title=paste(" Normalization by payload, sqrt(Payload) and Payload^2 \n model:",modeli,sep=""))
 
 show(p)

}


```
## Boggies Without platform
```{r plots boggies without platforms, echo = FALSE, fig.height=10, fig.width=14, fig.cap="---  \n"}

for(modeli in min(res2$model):max(res2$model)){
 model_id=modeli

 p <- ggplot(res2[res2$model == model_id,],aes(x = freq, y= c2)) + 
  geom_violin(aes(fill = as.factor(freq))) +
  geom_violin(data = res2[res2$model == model_id,],aes(
         x = freq + 0.25,
         y = c2/Speed,
         color = ExperimentID,
         fill = as.factor(freq)
  )) +
  geom_violin(data = res2[res2$model == model_id, ], aes(
       x = freq + 0.5,
         y = c2/((Speed)*(Payload)),
         color = ExperimentID,
         fill = as.factor(freq)
       ))  +
     geom_violin(data = res2[res2$model == model_id, ], aes(
         x = freq + 0.75,
         y = c2/((Speed^2)*(Payload^2)),
         color = ExperimentID,
         fill = as.factor(freq)
     ))+
  facet_grid(as.factor(Track) ~ as.factor(Speed)) +
  labs(title=paste("Normalization by Speed, Speed x Payload and Speed^2 x Payload^2 \n model:",modeli,sep=""))
 
 show(p)

 p <- ggplot(res2[res2$model == model_id,],aes(x = freq, y= c2)) + 
  geom_violin(aes(fill = as.factor(freq))) +
  geom_violin(data = res2[res2$model == model_id,],aes(
         x = freq + 0.25,
         y = c2/Payload,
         color = ExperimentID,
         fill = as.factor(freq)
  )) +
  geom_violin(data = res2[res2$model == model_id, ], aes(
       x = freq + 0.5,
         y = c2/(Payload^0.5),
         color = ExperimentID,
         fill = as.factor(freq)
       ))  +
     geom_violin(data = res2[res2$model == model_id, ], aes(
         x = freq + 0.75,
         y = c2/(Payload^2),
         color = ExperimentID,
         fill = as.factor(freq)
     ))+
  facet_grid(as.factor(Track) ~ as.factor(Speed)) +
  labs(title=paste(" Normalization by payload, sqrt(Payload) and Payload^2 \n model:",modeli,sep=""))
 
 show(p)

}

```

## Boggies with just wheels

```{r just wheel, echo = FALSE,fig.height=10, fig.width=14, fig.cap="---  \n"}

for(modeli in min(res3$model):max(res3$model)){
 model_id=modeli

 p <- ggplot(res3[res3$model == model_id,],aes(x = freq, y= c2)) + 
  geom_violin(aes(fill = as.factor(freq))) +
  geom_violin(data = res3[res3$model == model_id,],aes(
         x = freq + 0.25,
         y = c2/Speed,
         color = ExperimentID,
         fill = as.factor(freq)
  )) +
  geom_violin(data = res3[res3$model == model_id, ], aes(
       x = freq + 0.5,
         y = c2/((Speed)*(Payload)),
         color = ExperimentID,
         fill = as.factor(freq)
       ))  +
     geom_violin(data = res3[res3$model == model_id, ], aes(
         x = freq + 0.75,
         y = c2/((Speed^2)*(Payload^2)),
         color = ExperimentID,
         fill = as.factor(freq)
     ))+
  facet_grid(as.factor(Track) ~ as.factor(Speed)) +
  labs(title=paste("Wheels only \n Normalization by Speed, Speed x Payload and Speed^2 x Payload^2 \n model:",modeli,sep=""))
 
 show(p)

 p <- ggplot(res3[res3$model == model_id,],aes(x = freq, y= c2)) + 
  geom_violin(aes(fill = as.factor(freq))) +
  geom_violin(data = res3[res3$model == model_id,],aes(
         x = freq + 0.25,
         y = c2/Payload,
         color = ExperimentID,
         fill = as.factor(freq)
  )) +
  geom_violin(data = res3[res3$model == model_id, ], aes(
       x = freq + 0.5,
         y = c2/(Payload^0.5),
         color = ExperimentID,
         fill = as.factor(freq)
       ))  +
     geom_violin(data = res3[res3$model == model_id, ], aes(
         x = freq + 0.75,
         y = c2/(Payload^2),
         color = ExperimentID,
         fill = as.factor(freq)
     ))+
  facet_grid(as.factor(Track) ~ as.factor(Speed)) +
  labs(title=paste("Wheels only \n  Normalization by payload, sqrt(Payload) and Payload^2 \n model:",modeli,sep=""))
 
 show(p)
 
}

```

## what about Payload -train - model1

```{r payload - res1, echo = FALSE,fig.height=10, fig.width=14, fig.cap="---  \n"}

#models2<-summarize(group_by(res2,modeled_element,model))
for(modeli in min(res3$model):max(res3$model)){
#modeli=1
  p <- res1 %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2,color=as.factor(Track)))+
    geom_point()+
    facet_grid(.~freq)+
    labs(title="res1, train set only, c2")
  show(p)
#modeli=1
  p <- res1 %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2,color=as.factor(Speed)))+
    geom_point()+
    facet_grid(.~freq)+
    labs(title="res1, train set only, c2")
  show(p)
  
  p <- res1 %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2,color=as.factor(Speed)))+
    geom_point()+
    facet_grid(freq~.)+
    labs(title="res1, train set only, c2")
  show(p)
}

```


## what about Payload -train - model2

```{r payload - res2, echo = FALSE,fig.height=10, fig.width=14, fig.cap="---  \n"}

#models2<-summarize(group_by(res2,modeled_element,model))
for(modeli in min(res3$model):max(res3$model)){
#modeli=1
  p <- res2 %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2,color=as.factor(Track)))+
    geom_point()+
    facet_grid(.~freq)+
    labs(title="res2, train set only, c2")
  show(p)
#modeli=1
  p <- res2 %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2,color=as.factor(Speed)))+
    geom_point()+
    facet_grid(.~freq)+
    labs(title="res2, train set only, c2")
  show(p)
  
  p <- res2 %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2,color=as.factor(Speed)))+
    geom_point()+
    facet_grid(freq~.)+
    labs(title="res2, train set only, c2")
  show(p)
}

```

## what about Payload -train - model3

```{r payload -res3, echo = FALSE,fig.height=10, fig.width=14, fig.cap="---  \n"}

#models3<-summarize(group_by(res3,modeled_element,model))
for(modeli in min(res3$model):max(res3$model)){
#modeli=1
  p <- res3 %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2,color=as.factor(Track)))+
    geom_point()+
    facet_grid(.~freq)+
    labs(title="res3, train set only, c2")
  show(p)
#modeli=1
  p <- res3 %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2,color=as.factor(Speed)))+
    geom_point()+
    facet_grid(.~freq)+
    labs(title="res3, train set only, c2")
  show(p)
  
  p <- res3 %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2,color=as.factor(Speed)))+
    geom_point()+
    facet_grid(freq~.)+
    labs(title="res3, train set only, c2")
  show(p)
}

```
##Estimating on test data

```{r test data model 3, echo = FALSE,fig.height=10, fig.width=14, fig.cap="---  \n"}

# boggie models just with wheels
source("./R Scripts/models_eq3.R")

res3_test<-run_fits(model_df = models, data_df = data_test)

res3_test$Track<-ifelse(res3_test$ExperimentID<101,1,2)

```
## plots with test set

```{r plots train + test - model 3, echo = FALSE,fig.height=10, fig.width=14, fig.cap="---  \n"}

#models3<-summarize(group_by(res3,modeled_element,model))

for(modeli in min(res3$model):max(res3$model)){
#modeli=1
  p <- res3 %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2,color=as.factor(Track)))+
    geom_point()+
    facet_grid(.~freq)+
    geom_point(data=res3_test[res3_test$model == modeli,],aes(
      x=Payload,
      y=c2),color="black")
  show(p)
  
  #track 1 only
}
  #track 1 only

wrk<-filter(res3,Track==1)
wrk_test<-filter(res3_test,Track==1)
for(modeli in min(res3$model):max(res3$model)){

#modeli=1
  p <- wrk %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2))+
    geom_point(color = "black")+
    facet_grid(.~freq)+
    geom_point(data=wrk_test[wrk_test$model == modeli,],aes(
      x=Payload,
      y=c2,color=as.factor(Speed)),shape=2,size=3)+
    labs(title="Track 1 - train'n'test - model3")
  show(p)
  

}

wrk<-filter(res3,Track==2)
wrk_test<-filter(res3_test,Track==2)
for(modeli in min(res3$model):max(res3$model)){

#modeli=1
  p <- wrk %>% filter(model == modeli) %>%
    ggplot(.,aes(x=Payload,y=c2))+
    geom_point(color="black")+
    facet_grid(.~freq)+
    geom_point(data=wrk_test[wrk_test$model == modeli,],aes(
      x=Payload,
      y=c2,color=as.factor(Speed)),shape=2,size=3)+
    labs(title="Track 2 - train'n'test - model3")
  show(p)
  

}

```
## Conclusions (from Antek)

Simplest model (only wheel excitation) seems best. 
Normalization - at first glance - by sqrt(payload)

additionally - track 2 may have different type of excitation than track 1 - to be continued

to do:
1. theoretical validation - C2 >0 (should be)
2. analytical validation - k-folds? lets see how many healthy cars we mark as failed?
3. prob(outside normal bounds) per freq and per ID

