---
author: "Antek"
date: "7 July 2017"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}

rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)

require(ggplot2)

#library(vars)
```

## Intro

This documents the fforts to create a better model than eq3 - so bogie corner acc as a function of wheel acc 

```{r data in, echo = FALSE}

# reading in data
data_train <- readRDS("./input/train_data.RDS")

data_test  <- readRDS("./input/test_data.RDS")

#linear models:
source("./R Scripts/linear_models.R")

```

## Models

### eq3

kept here for reference - as it might be the best thing so far
  
```{r eq3, echo = FALSE}

source("./R Scripts/models_eq3.R")

res3<-run_fits(model_df = models, data_df = data_train)

res3$Track<-ifelse(res3$ExperimentID<101,1,2)

res3_test<-run_fits(model_df = models, data_df = data_test)

res3_test$Track<- ifelse (res3_test$ExperimentID<101,1,2)

```

### eq4

this is an attempt at estimating bogie and platform models  
each model is a simple "y = a + b * x" linear model  
for bogie corner acc - there are one each model - all using wheels as inputs
for platforms - there are four models for each platform acc each using a single bogie acc as input

```{r eq4, echo = FALSE}


source("./R Scripts/models_eq4.R")

res4<-run_fits(model_df = models, data_df = data_train)

res4$Track<-ifelse(res4$ExperimentID<101,1,2)

res4$x1<-substr(res4$lm_cmd,9,14)

```

### ploting eq4

```{r eq4 plots, echo = FALSE}

res4 %>% filter(model > 8 & model < 13) %>%
  ggplot(.,aes(x=Payload,y=c2,color=as.factor(Track)))+
  geom_point()+
  facet_grid(model~freq)+
  labs(title="c2 platform=f(bogie), by freq (1-5) and eq4 model (9-12)")

res4 %>% filter(model > 8 & model < 13) %>%
  ggplot(.,aes(x=Speed,y=c2,color=as.factor(Track)))+
  geom_point()+
  facet_grid(model~freq)+
  labs(title="c2 platform=f(bogie), by freq (1-5) and eq4 model (9-12), color by Track")

res4 %>% filter(model > 8 & model < 13) %>%
  ggplot(.,aes(x=Speed,y=c2,color=as.factor(x1)))+
  geom_point()+
  facet_grid(model~freq)+
  labs(title="c2 platform=f(bogie), by freq (1-5) and eq4 model (9-12)")


```


### test set flags - based on eq3 and normal distribution

```{r flags eq3, echo = FALSE}

summary_res_3<-summarize(group_by(res3,Track,Speed,freq,model),avg=mean(c2),st_dev=sd(c2))

res3_test_flags<-merge(res3_test,summary_res_3,by=c("Track","Speed","freq","model"),all.x=TRUE)

res3_test_flags$pdb_up<-pnorm(res3_test_flags$c2,
                              mean = res3_test_flags$avg,
                              sd = res3_test_flags$st_dev,
                              lower.tail = FALSE)


res3_test_flags$pdb<-pnorm(res3_test_flags$c2,
                              mean = res3_test_flags$avg,
                              sd = res3_test_flags$st_dev)

sum_pdb<- summarize(group_by(res3_test_flags,ExperimentID,modeled_element),
                    max_pdb=max(pdb_up),
                    count_up_50=sum(pdb_up>0.5),
                    count_pdb_50=sum(pdb>.50))

sum_pdb_id<- summarize(group_by(res3_test_flags,ExperimentID),
                    max_pdb=max(pdb_up),
                    count_up_50=sum(pdb_up>0.5),
                    count_pdb_50=sum(pdb>.50))


```

## eq4 vs. test

### run
this part runs the linear fits

```{r eq4 test, echo = FALSE}

source("./R Scripts/models_eq4.R")

res4_test<-run_fits(model_df = models, data_df = data_test)

#res4$Track<-ifelse(res4$ExperimentID<101,1,2)

res4_test$x1<-substr(res4_test$lm_cmd,9,14)

```

### plots

here we compare plots - healthy vs. unhealthy
```{r eq3 test plots, echo = FALSE}

p <- res4_test %>% filter(model > 8 & model < 13) %>%
  ggplot(.,aes(x=Speed,y=c2,color=as.factor(x1)))+
  geom_point()+
  facet_grid(model~freq)

p + res4 %>% filter(model > 8 & model < 13) %>%
  geom_point(data=.,aes(x=Speed,y=c2),color="green", alpha = 0.5)+
  facet_grid(model~freq)+
  labs(title="c2 forward platform=f(bogie), by freq (1-5) and eq4 model (9-12)")


p <- res4_test %>% filter(model > 12 & model < 17) %>%
  ggplot(.,aes(x=Speed,y=c2,color=as.factor(x1)))+
  geom_point()+
  facet_grid(model~freq)

p + res4 %>% filter(model > 12 & model < 17) %>%
  geom_point(data=.,aes(x=Speed,y=c2),color="green", alpha = 0.5)+
  facet_grid(model~freq)+
  labs(title="c2 aft platform=f(bogie), by freq (1-5) and eq4 model (9-12)")

```