---
title: "Line Plots"
author: "Marcin Borucki"
date: "9 lipca 2017"
output: 
  html_document:
    toc: true
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(ggplot2)
require(dplyr)
require(tidyr)
# memory.limit(10000)
```

##  Intro

Applying final model for primary suspension: 
    Square root of payload normalization.
    Only one accel above the while.
    
    

##Read in data

```{r read in data and functions}

# data_train <- readRDS("./input/train_data.RDS")
# 
# data_test  <- readRDS("./input/test_data.RDS")

train_data <- readRDS("./input/train_data.RDS")

test_data  <- readRDS("./input/test_data.RDS")

#functions :
source("./R/Data_challenge_functions.R")


#linear models:
source("./R Scripts/linear_models.R")


```    

## Linear models  
  
this part is focused on separate linear models for all spring- dumper pairs.

```{r linear models}

# original models
## Not to be used (MB)
# source("./R Scripts/models_eq1.R")
# 
# res1<-run_fits(model_df = models, data_df = data_train)
## added this part to the script of model fit run 
## res1$Track<-ifelse(res1$ExperimentID<101,1,2)
# boggie models without platform
## Not to be used (MB)
# source("./R Scripts/models_eq2.R")
# 
# res2<-run_fits(model_df = models, data_df = data_train)
## added this part to the script of model fit run
# #res2$Track<-ifelse(res2$ExperimentID<101,1,2)

# boggie models just with wheels
source("./R Scripts/models_eq3_azp.R")

res3<-run_fits(model_df = models, data_df = data_train)

# boggie models just with wheels and platform
# source("./R Scripts/models_eq4_azp.R")
# 
# res4<-run_fits(model_df = models, data_df = data_train)


```


## Runing lienar plot model3

```{r Freq line plot -res3, eval=FALSE, fig.cap="---  \n", fig.height=8, fig.width=14, include=FALSE}


for (modeli in min(res3$model):max(res3$model)) {
    mod_el <- res3 %>% filter(model == modeli) %>% 
        select(modeled_element) %>% distinct()
p <- res3 %>% filter(model == modeli) %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = Payload,
                  group = ExperimentID
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, train set only, c2", mod_el, modeli, sep=" ")) + 
    scale_color_gradient(
        low = "red",
        high = "yellow") 
    show(p)
}


for (modeli in min(res4$model):max(res4$model)) {
    mod_el <- res4 %>% filter(model == modeli) %>% 
        select(modeled_element) %>% distinct()
p <- res4 %>% filter(model == modeli) %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = Payload,
                  group = ExperimentID
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res4, train set only, c2", mod_el, modeli, sep=" ")) + 
    scale_color_gradient(
        low = "red",
        high = "yellow") 
    show(p)
}



```

Cocnlusions from the above - model 4 with additional acell is more noisy!

Stick to model 3 
## Grouping models
Verify potential grouping by right and left and 1&3 and 2&4...


```{r Model -res4, eval=FALSE, fig.cap="---  \n", fig.height=10, fig.width=14, include=FALSE}

p <- res3 %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(grepl('*r',modeled_element)),
                  alpha = 0.5,
                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, train set only, c2, grouping by left and right")) 
    show(p)
    
p <- res3 %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(grepl('([13])',modeled_element)),
                  alpha = 0.5,
                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, train set only, c2, grouping by first bogie axis and latter")) 
    show(p)
    
    
p <- res3 %>% 
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(grepl("([12])",modeled_element) ),
                  alpha = 0.5,
                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, train set only, c2, grouping by bogie ")) 
    show(p)
    
```

```{r Run model 3 on test data, eval=FALSE, include=FALSE}
# source("./R Scripts/models_eq3_azp.R")
# 
res_test <- run_fits(model_df = models, data_df = data_test)

```

```{r Model 3 test data, eval=FALSE, fig.cap="---  \n", fig.height=10, fig.width=14, include=FALSE}


p <- bind_rows(mutate(res_test, data_set = "test_set") , mutate(res3, data_set = "train_set")) %>% filter(modeled_element == "azp_1r") %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(data_set ),
                  # alpha = 0.5,
                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line(alpha = 0.5) +
    facet_grid(Speed ~ Track) +
    labs(title = paste("Res3, test set and train set, c2, grouping by data set "))

    show(p)

    
p <- bind_rows(mutate(res_test, data_set = "test_set") , mutate(res3, data_set = "train_set")) %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(data_set ),

                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line(alpha = 0.5) +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, test set and train set, c2, grouping by test set "))

    show(p)
    
    
p <- bind_rows(mutate(res_test, data_set = "test_set") , mutate(res3, data_set = "train_set")) %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(data_set ),

                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line(alpha = 0.25) +
    facet_grid(modeled_element ~ Track) +
    labs(title = paste("Res3, test set and train set, c2, grouping by experiment and model on both test and train "))

    show(p)
    
    
p <- bind_rows(res_test, res3) %>% 
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(grepl("([12])",modeled_element) ),
                  alpha = 0.5,
                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, test set and train set, c2, grouping by bogie "))

    show(p)


```
## Excitation level analysis
```{r Excitation level, eval=FALSE, include=FALSE}

# Track 1
 some_trainig <- train_data %>% filter(ExperimentID == 12 )
lr = "r"
band = 2
# az
plot_groups(some_trainig,
             var = "az",
             par_range = c(1:4),
             lr = lr,
             freq_band = band)
# az
# Track 2 strange speed
 some_trainig <- train_data %>% filter(ExperimentID == 193 )
plot_groups(some_trainig,
             var = "az",
             par_range = c(1:4),
             lr = lr,
             freq_band = band)


substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

# MIN
train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(ExperimentID, Payload, Speed, Track,State) %>% 
    summarise_each_( funs(min), matches("az_*")) %>% gather( "variable", "summart_val", -ExperimentID, -Payload, -Speed, -Track,-State) %>% mutate( freq_band =  substrRight(variable, 1)) %>%
    ggplot(., aes(x = ExperimentID,
                  y = summart_val,
                  color = freq_band
    )) + geom_point()

# MAX
train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(ExperimentID, Payload, Speed, Track,State) %>% 
    summarise_each_( funs(max), matches("az_*")) %>% gather( "variable", "summart_val", -ExperimentID, -Payload, -Speed, -Track,-State) %>% mutate( freq_band =  substrRight(variable, 1)) %>%
    ggplot(., aes(x = ExperimentID,
                  y = summart_val,
                  color = freq_band
    )) + geom_point()
# MEDIAN
train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(ExperimentID, Payload, Speed, Track,State) %>% 
    summarise_each_( funs(median), matches("az_*")) %>% gather( "variable", "summart_val", -ExperimentID, -Payload, -Speed, -Track,-State) %>% mutate( freq_band =  substrRight(variable, 1)) %>%
    ggplot(., aes(x = ExperimentID,
                  y = summart_val,
                  color = freq_band
    )) + geom_point()

# MEDIAN Speed
train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(#ExperimentID, Payload,
             Speed, Track,State) %>% 
    summarise_each_( funs(median), matches("az_*")) %>% gather( "variable", "summart_val", -ExperimentID, -Payload, -Speed, -Track,-State) %>% mutate( freq_band =  substrRight(variable, 1)) %>%
    ggplot(., aes(x = (Speed),
                  y = summart_val,
                  color = freq_band
    )) + geom_point()

# mean
train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(#ExperimentID, Payload,
             Speed, Track,State) %>% 
    summarise_each_( funs(mean), matches("az_*")) %>% gather( "variable", "summart_val", -ExperimentID, -Payload, -Speed, -Track,-State) %>% mutate( freq_band =  substrRight(variable, 1)) %>%
    ggplot(., aes(x = (Speed),
                  y = summart_val,
                  color = freq_band
    )) + geom_point()

```
## Cut off on excitation level

```{r linear models - with higl low excitation cut-off, eval=FALSE, include=FALSE}
# source("./R Scripts/models_eq3_azp.R")
# Median based filtering
train_data_filter <- train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(ExperimentID, Payload, Speed, Track,State) %>% 
    summarise_each_( funs(median), matches("az_*")) %>%
    gather(filter_var, cut_off, matches("az_.") )

# left_join(train_data,  train_data_filter, by = "ExperimentID", suffix = c("", "_f") ) 
# %>%
 
  train_data_f_low <-  train_data %>%  gather(filter_var, value, matches("az_.") ) %>% ## pre filter stacked rows 2,416,000
        left_join(train_data_filter ) %>% filter( value <= cut_off)  %>%  ## post filter rows 1,208,003
        select(-cut_off) %>% spread(filter_var, value) %>%
      adply(., 1, .fun = function(x) { data.frame(filter_na = !anyNA(x) ) }) %>%
      filter(filter_na == TRUE)
t <- train_data_f_low %>% group_by(ExperimentID) %>% dplyr::summarise(cr = n()) 
  
res3_f_low_1 <-run_fits(model_df = models, data_df = train_data_f_low)

    train_data_f_high <-  train_data %>%  gather(filter_var, value, matches("az_.") ) %>% 
        left_join(train_data_filter ) %>% filter( value >= cut_off)  %>%  
        select(-cut_off) %>% spread(filter_var, value)  %>% 
      adply(., 1, .fun = function(x) { data.frame(filter_na = !anyNA(x) ) }) %>%
      filter(filter_na == TRUE)
    
t <- train_data_f_high %>% group_by(ExperimentID) %>% dplyr::summarise(cr = n()) 

  res3_f_high_1 <-run_fits(model_df = models, data_df = train_data_f_high)
# boggie models just with wheels




```

### Filtering on Track level (not experiment level) and leaving NAs for lm to handle
Using median and 85th quantile
```{r linear models - with higl low excitation cut-off - 85th quantile, echo=TRUE}
# source("./R Scripts/models_eq3_azp.R")
# Median based filtering  res3_f_low_2

train_data_filter <- train_data %>% select( Track, matches("az_.")) %>% 
    group_by(Track) %>% 
    # summarise_each_( funs(quantile(., c(.85))), matches("az_*")) %>%
    summarise_each_( funs(median), matches("az_*")) %>%
    gather(filter_var, cut_off, matches("az_.") )

# left_join(train_data,  train_data_filter, by = "ExperimentID", suffix = c("", "_f") ) 
# %>%
 
  train_data_f_low <-  train_data %>%  gather(filter_var, value, matches("az_.") ) %>% ## pre filter stacked rows 2,416,000
        left_join(train_data_filter ) %>% filter( value <= cut_off)  %>%  ## post filter rows 1,208,003
        select(-cut_off) %>% spread(filter_var, value) 

  
res3_f_low_2 <-run_fits(model_df = models, data_df = train_data_f_low)


    train_data_f_high <-  train_data %>%  gather(filter_var, value, matches("az_.") ) %>% 
        left_join(train_data_filter ) %>% filter( value >= cut_off)  %>%  
        select(-cut_off) %>% spread(filter_var, value) 

res3_f_high_2 <-run_fits(model_df = models, data_df = train_data_f_high)


# Quiteail 85% based filtering  res3_f_low_3
train_data_filter <- train_data %>% select( Track, matches("az_.")) %>% 
    group_by(Track) %>% 
    summarise_each_( funs(quantile(., c(.85))), matches("az_*")) %>%
    # summarise_each_( funs(median), matches("az_*")) %>%
    gather(filter_var, cut_off, matches("az_.") )

  train_data_f_low <-  train_data %>%  gather(filter_var, value, matches("az_.") ) %>% #
        left_join(train_data_filter ) %>% filter( value <= cut_off)  %>%  
        select(-cut_off) %>% spread(filter_var, value) 
  
      train_data_f_high <-  train_data %>%  gather(filter_var, value, matches("az_.") ) %>% 
        left_join(train_data_filter ) %>% filter( value >= cut_off)  %>%  
        select(-cut_off) %>% spread(filter_var, value) 

res3_f_low_3 <-run_fits(model_df = models, data_df = train_data_f_low)
res3_f_high_3 <-run_fits(model_df = models, data_df = train_data_f_high)

```


### Filtering on experiment levelel and leaving NAs to the LM with 85th quantail 

```{r linear models - with higl low excitation cut-off - 85th quantile easy on  NA}
# source("./R Scripts/models_eq3_azp.R")
# Median based filtering
train_data_filter <- train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(ExperimentID, Payload, Speed, Track,State) %>% 
     summarise_each_( funs(quantile(., c(.85))), matches("az_*")) %>%
   gather(filter_var, cut_off, matches("az_.") )

# left_join(train_data,  train_data_filter, by = "ExperimentID", suffix = c("", "_f") ) 
# %>%
 
  train_data_f_low <-  train_data %>%  gather(filter_var, value, matches("az_.") ) %>% ## pre filter stacked rows 2,416,000
        left_join(train_data_filter ) %>% filter( value <= cut_off)  %>%  ## post filter rows 1,208,003
        select(-cut_off) %>% spread(filter_var, value) 
  
res3_f_low_4 <-run_fits(model_df = models, data_df = train_data_f_low)

    train_data_f_high <-  train_data %>%  gather(filter_var, value, matches("az_.") ) %>% 
        left_join(train_data_filter ) %>% filter( value >= cut_off)
    
  # res3_f_high_4 <-run_fits(model_df = models, data_df = train_data_f_high)
# boggie models just with wheels


```
Doesn' work that well 

## Review of the resutls
```{r Model -res4 with high low filters, eval=FALSE, fig.cap="---  \n", include=FALSE}


# plot_lines(res3_f_low_1, "Low Pass filter v1 fit")
# plot_lines(res3_f_high_1, "High Pass filter v1 fit")
# to aggresive filtering!!

plot_lines(res3, "All data fit")

plot_lines(res3_f_low_3, "Low Pass filter v3 fit q 85th track level")
plot_lines(res3_f_high_3, "High Pass filter v3 fit q 85th track level")
# 
plot_lines(res3_f_low_2, "Low Pass filter v2 fit median track level")
plot_lines(res3_f_high_2, "High Pass filter v2 fit median track level")


p <- bind_rows(mutate(res3, origin = "res3"), mutate(res3_f_low_3, origin = "res3_f_low_3") ) %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = origin,
                  group = interaction(origin,modeled_element,ExperimentID)
    )) +
    geom_line(alpha = 0.5) +
    facet_grid(Speed ~ .) +
    scale_y_continuous(limits = c(0.0, 1.5))+
    labs(title = paste("Low Pass filter v4 fit q 85th track level vs base line")) 
show(p)


p <- bind_rows(mutate(res3, origin = "res3"), mutate(res3_f_low_4, origin = "res3_f_low_4") ) %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = origin,
                  group = interaction(origin,modeled_element,ExperimentID)
    )) +
    geom_line(alpha = 0.5) +
    facet_grid(Speed ~ .) +
    scale_y_continuous(limits = c(0.0, 1.5))+
    labs(title = paste("Low Pass filter v4 fit q 85th experiment level vs base line")) 
show(p)


    
```
```{r Track level comparison v3 and v4, echo=TRUE}
t <- bind_rows(mutate(res3, origin = "res3"),
               mutate(res3_f_low_4, origin = "res3_f_low_4"),
               mutate(res3_f_low_3, origin = "res3_f_low_3")) %>%
    group_by(origin, Track, freq) %>%
    dplyr::summarise(mean_c2 = mean(c2), sd_c2 = sd(c2) )
    

p <- t  %>%
    ggplot(., aes(x = freq + as.numeric(as.factor(origin))/10,
                  y = mean_c2,
                  color = origin,
                  group = interaction(origin)
    )) +
    geom_line(alpha = 0.5) +
    geom_linerange(aes(ymin = (mean_c2 - sd_c2), ymax = (mean_c2 + sd_c2))) +
    facet_grid(Track ~ .) +
    # scale_y_continuous(limits = c(0.0, 1.5))+
    labs(title = paste("Low Pass filter v3 & v4 fit q 85th vs base line on over all agv + sd  track level ")) 
show(p)

# Per modeled element
t <- bind_rows(mutate(res3, origin = "res3"),
               mutate(res3_f_low_4, origin = "res3_f_low_4"),
               mutate(res3_f_low_3, origin = "res3_f_low_3")) %>%
    group_by(origin, Track, modeled_element, freq) %>%
    dplyr::summarise(mean_c2 = mean(c2), sd_c2 = sd(c2) )
    

p <- t  %>%
    ggplot(., aes(x = freq + as.numeric(as.factor(interaction(origin,modeled_element)))/100,
                  y = mean_c2,
                  color = origin,
                  group = interaction(origin,modeled_element)
    )) +
    geom_line(alpha = 0.5) +
    geom_linerange(aes(ymin = (mean_c2 - sd_c2), ymax = (mean_c2 + sd_c2))) +
    facet_grid(Track ~ .) +
    # scale_y_continuous(limits = c(0.0, 1.5))+
    labs(title = paste("Low Pass filter v3 & v4 fit q 85th vs base line on over all agv + sd  track level ")) 
show(p)
```

## Conclusions of the filtering

It seems that filtering out hith excitation values is improving the variance of the fits.
For Track 1 this conclusion not always hold but the change is in my opinion minor. 

Real improvement is visible at Track 2.

**Modeling approach: Preper the model per exact part & track, but not speed o payload.**
**Use Low Pass filter v4 fit q 85th track level.** This will allow the model to perform also with unnknown payloads and speeds.