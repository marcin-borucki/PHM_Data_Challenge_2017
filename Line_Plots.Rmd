---
title: "Line Plots"
author: "Marcin Borucki"
date: "4 lipca 2017"
output: 
  html_document:
    toc: true
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
#library(dplyr)

```

##  Intro

Applying final model for primary suspension: 
    Square root of payload normalization.
    Only one accel above the while.
    
    

##Read in data

```{r read in data and functions}

data_train <- readRDS("./input/train_data.RDS")

data_test  <- readRDS("./input/test_data.RDS")

#functions :
source("./R/Data_challenge_functions.R")


#linear models:
source("./R Scripts/linear_models.R")


```    

## Linear models  
  
this part is focused on separate linear models for all spring- dumper pairs.

```{r linear models}

# original models
## Not to be used (MB)
# source("./R Scripts/models_eq1.R")
# 
# res1<-run_fits(model_df = models, data_df = data_train)
## added this part to the script of model fit run 
## res1$Track<-ifelse(res1$ExperimentID<101,1,2)
# boggie models without platform
## Not to be used (MB)
# source("./R Scripts/models_eq2.R")
# 
# res2<-run_fits(model_df = models, data_df = data_train)
## added this part to the script of model fit run
# #res2$Track<-ifelse(res2$ExperimentID<101,1,2)

# boggie models just with wheels
source("./R Scripts/models_eq3_azp.R")

res3<-run_fits(model_df = models, data_df = data_train)

# boggie models just with wheels and platform
source("./R Scripts/models_eq4_azp.R")

res4<-run_fits(model_df = models, data_df = data_train)


```


## Runing lienar plot model3

```{r Freq line plot -res3, echo = FALSE,fig.height=8, fig.width=14, fig.cap="---  \n"}


for (modeli in min(res3$model):max(res3$model)) {
    mod_el <- res3 %>% filter(model == modeli) %>% 
        select(modeled_element) %>% distinct()
p <- res3 %>% filter(model == modeli) %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = Payload,
                  group = ExperimentID
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, train set only, c2", mod_el, modeli, sep=" ")) + 
    scale_color_gradient(
        low = "red",
        high = "yellow") 
    show(p)
}


for (modeli in min(res4$model):max(res4$model)) {
    mod_el <- res4 %>% filter(model == modeli) %>% 
        select(modeled_element) %>% distinct()
p <- res4 %>% filter(model == modeli) %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = Payload,
                  group = ExperimentID
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res4, train set only, c2", mod_el, modeli, sep=" ")) + 
    scale_color_gradient(
        low = "red",
        high = "yellow") 
    show(p)
}



```

Cocnlusions from the above - model 4 with additional acell is more noisy!

Stick to model 3 
## Grouping models
Verify potential grouping by right and left and 1&3 and 2&4...


```{r Model -res4, echo = FALSE,fig.height=10, fig.width=14, fig.cap="---  \n"}

p <- res3 %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(grepl('*r',modeled_element)),
                  alpha = 0.5,
                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, train set only, c2, grouping by left and right")) 
    show(p)
    
p <- res3 %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(grepl('([13])',modeled_element)),
                  alpha = 0.5,
                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, train set only, c2, grouping by first bogie axis and latter")) 
    show(p)
    
    
p <- res3 %>% 
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(grepl("([12])",modeled_element) ),
                  alpha = 0.5,
                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, train set only, c2, grouping by bogie ")) 
    show(p)
    
```

```{r Run model 3 on test data}
source("./R Scripts/models_eq3_azp.R")

res_test <- run_fits(model_df = models, data_df = data_test)

```

```{r Model 3 test data, echo=FALSE, fig.cap="---  \n", fig.height=10, fig.width=14}


p <- bind_rows(mutate(res_test, data_set = "test_set") , mutate(res3, data_set = "train_set")) %>% filter(modeled_element == "azp_1r") %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(data_set ),
                  # alpha = 0.5,
                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line(alpha = 0.5) +
    facet_grid(Speed ~ Track) +
    labs(title = paste("Res3, test set and train set, c2, grouping by data set "))

    show(p)

    
p <- bind_rows(mutate(res_test, data_set = "test_set") , mutate(res3, data_set = "train_set")) %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(data_set ),

                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line(alpha = 0.5) +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, test set and train set, c2, grouping by test set "))

    show(p)
    
    
p <- bind_rows(mutate(res_test, data_set = "test_set") , mutate(res3, data_set = "train_set")) %>%
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(data_set ),

                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line(alpha = 0.25) +
    facet_grid(modeled_element ~ Track) +
    labs(title = paste("Res3, test set and train set, c2, grouping by experiment and model on both test and train "))

    show(p)
    
    
p <- bind_rows(res_test, res3) %>% 
    ggplot(., aes(x = freq,
                  y = c2,
                  color = as.factor(grepl("([12])",modeled_element) ),
                  alpha = 0.5,
                  group = interaction(modeled_element,ExperimentID)
    )) +
    geom_line() +
    facet_grid(Speed ~ .) +
    labs(title = paste("Res3, test set and train set, c2, grouping by bogie "))

    show(p)


```
## Excitation level analysis
```{r Excitation level, echo=TRUE}

# Track 1
 some_trainig <- train_data %>% filter(ExperimentID == 12 )
lr = c("r","l")
band = 2
# az
plot_groups(some_trainig,
             var = "az",
             par_range = c(1:4),
             lr = lr,
             freq_band = band)
# az
# Track 2 strange speed
 some_trainig <- train_data %>% filter(ExperimentID == 193 )
plot_groups(some_trainig,
             var = "az",
             par_range = c(1:4),
             lr = lr,
             freq_band = band)


substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

# MIN
train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(ExperimentID, Payload, Speed, Track,State) %>% 
    summarise_each_( funs(min), matches("az_*")) %>% gather( "variable", "summart_val", -ExperimentID, -Payload, -Speed, -Track,-State) %>% mutate( freq_band =  substrRight(variable, 1)) %>%
    ggplot(., aes(x = ExperimentID,
                  y = summart_val,
                  color = freq_band
    )) + geom_point()

# MAX
train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(ExperimentID, Payload, Speed, Track,State) %>% 
    summarise_each_( funs(max), matches("az_*")) %>% gather( "variable", "summart_val", -ExperimentID, -Payload, -Speed, -Track,-State) %>% mutate( freq_band =  substrRight(variable, 1)) %>%
    ggplot(., aes(x = ExperimentID,
                  y = summart_val,
                  color = freq_band
    )) + geom_point()
# MEDIAN
train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(ExperimentID, Payload, Speed, Track,State) %>% 
    summarise_each_( funs(median), matches("az_*")) %>% gather( "variable", "summart_val", -ExperimentID, -Payload, -Speed, -Track,-State) %>% mutate( freq_band =  substrRight(variable, 1)) %>%
    ggplot(., aes(x = ExperimentID,
                  y = summart_val,
                  color = freq_band
    )) + geom_point()

# MEDIAN Speed
train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(#ExperimentID, Payload,
             Speed, Track,State) %>% 
    summarise_each_( funs(median), matches("az_*")) %>% gather( "variable", "summart_val", -ExperimentID, -Payload, -Speed, -Track,-State) %>% mutate( freq_band =  substrRight(variable, 1)) %>%
    ggplot(., aes(x = (Speed),
                  y = summart_val,
                  color = freq_band
    )) + geom_point()

# mean
train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(#ExperimentID, Payload,
             Speed, Track,State) %>% 
    summarise_each_( funs(mean), matches("az_*")) %>% gather( "variable", "summart_val", -ExperimentID, -Payload, -Speed, -Track,-State) %>% mutate( freq_band =  substrRight(variable, 1)) %>%
    ggplot(., aes(x = (Speed),
                  y = summart_val,
                  color = freq_band
    )) + geom_point()

```
## Cut off on excitation level

```{r linear models - with higl low excitation cut-off}

train_data %>% select(ExperimentID, Payload, Speed, Track,State, matches("az_.")) %>% 
    group_by(ExperimentID, Payload, Speed, Track,State) %>% 
    summarise_each_( funs(median), matches("az_*")) 
    
# boggie models just with wheels
source("./R Scripts/models_eq3_azp.R")

res3<-run_fits(model_df = models, data_df = data_train)

```